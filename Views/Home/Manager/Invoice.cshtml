@model List<moon.Models.Order>  // ✔ CHÍNH XÁC

@{
    Layout = "~/Views/Shared/Manager.cshtml";
    ViewData["Title"] = "Hóa đơn";
}

<div class="container-fluid">

                    <!-- Page Heading -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 text-gray-800">Danh sách hóa đơn</h1>
                        
                    </div>


                    <!-- DataTales Example -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Bảng hóa đơn:</h6>

                            <!-- <div class="form-inline">
                                <div class="form-group mb-0 mr-2">
                                <label for="fromDate" class="mr-1 small">Từ</label>
                                <input type="date" class="form-control form-control-sm" id="fromDate">
                                </div>
                                <div class="form-group mb-0">
                                <label for="toDate" class="mr-1 small">Đến</label>
                                <input type="date" class="form-control form-control-sm" id="toDate">
                                </div>
                            </div> -->
                            </div>

                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Tên khách hàng</th>
                                            <th>Chi tiết đơn hàng</th>
                                            <th>Địa chỉ giao hàng</th>
                                            <th>Tổng tiền</th>
                                            <th>Ngày đặt hàng</th>
                                            <th>Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody>
@foreach (var order in Model)
{
    <tr>
        <td>@order.FullName</td>
        <td>
            @if (order.Items != null)
            {
                foreach (var item in order.Items)
                {
                    <span>@item.Quantity x @item.ProductName</span><br />
                }
            }
            else
            {
                <span>Không có sản phẩm</span>
            }
        </td>
        <td data-ward="@order.Ward" data-district="@order.District" data-province="@order.Province">
            Đang tải...
        </td>
        <td>@order.TotalAmount.ToString("N0")đ</td>
        <td>@order.OrderDate.ToString("yyyy-MM-dd")</td>
        <td>@order.Note</td>
    </tr>
}
</tbody>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>


@section Scripts {
    <script>
        // Tải dữ liệu tỉnh/huyện/xã
        async function loadLocationData() {
            const [provinces, districts, wards] = await Promise.all([
                fetch("https://provinces.open-api.vn/api/p/").then(res => res.json()),
                fetch("https://provinces.open-api.vn/api/d/").then(res => res.json()),
                fetch("https://provinces.open-api.vn/api/w/").then(res => res.json())
            ]);

            // Duyệt qua tất cả các ô địa chỉ để thay đổi mã thành tên
            document.querySelectorAll("td[data-ward]").forEach(td => {
                const wardCode = td.dataset.ward;
                const districtCode = td.dataset.district;
                const provinceCode = td.dataset.province;

                const ward = wards.find(w => w.code == wardCode);
                const district = districts.find(d => d.code == districtCode);
                const province = provinces.find(p => p.code == provinceCode);

                const wardName = ward ? ward.name : wardCode;
                const districtName = district ? district.name : districtCode;
                const provinceName = province ? province.name : provinceCode;

                td.innerText = `${wardName}, ${districtName}, ${provinceName}`;
            });
        }

        document.addEventListener("DOMContentLoaded", loadLocationData);
    </script>
}
